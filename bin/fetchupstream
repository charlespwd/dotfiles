#!/bin/bash

has_branch() {
  git branch | grep -q $1
}

run() {
  echo "$@" 1>&2
  "$@"
}

get_branch() {
  if has_branch "develop"; then
    echo -n "develop"
  elif has_branch "main"; then
    echo -n "main"
  else
    echo -n "master"
  fi
}

if [[ $1 != '-n' ]] && [[ $1 != '' ]]; then
  echo "Usage: fetchupstream [-n]"
  exit 1
fi

if [[ $1 != '-n' ]]; then
  # gwip
  git add -A
  git rm $(git ls-files --deleted) 2> /dev/null
  git commit --no-verify -m "--wip-- [skip ci]"
fi

upstream=$(git remote | grep upstream | head -n 1)
remote="${upstream:-origin}"
branch="$(get_branch)"

set -e

run git checkout "$branch"
run git fetch "$remote" || true
run git reset --hard "$remote/$branch"
run git fetch --tags "$remote"
if [[ $remote != 'origin' ]]; then
  run git push -f origin $branch
fi;
